<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡Æ§‡ØÅ‡Æ∞‡Øç‡Æï‡Ææ AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Thambi+2:wght@400;500&family=Catamaran:wght@400;500&family=Mukta+Malar:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="stylenew.css">
    <link rel="icon" type="image/png" href="/static2.0/Durga.png">
</head>
<body>
    <header>
        <div class="branding">
            <img src="/static2.0/Durga.png" alt="AI Logo" class="logo">
            <h1>‡Æ§‡ØÅ‡Æ∞‡Øç‡Æï‡Ææ AI</h1>
        </div>
        <div class="menu-container">
            <div class="dropdown">
                <button class="menu-button">Files</button>
                <div class="dropdown-content">
                    <a href="#" class="dropdown-item" onclick="handleUploadFile()">Upload File</a>
                    <a href="#" class="dropdown-item" onclick="handleOpenFile()">Open File</a>
                    <a href="#" class="dropdown-item" onclick="handleOpenFolder()">Open Folder</a>
                    <a href="#" class="dropdown-item" onclick="handleSaveAs()">Save As</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="menu-button">Agents</button>
                <div class="dropdown-content">
                    <a href="#" class="dropdown-item" onclick="handleBrowserAgent()">Browser Agent</a>
                    <a href="#" class="dropdown-item" onclick="handleDocumentAgent()">Document Agent</a>
                    <a href="#" class="dropdown-item" onclick="handleTwitterAgent()">Twitter Agent</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="menu-button">Language</button>
                <div class="dropdown-content">
                    <a href="#" class="dropdown-item" onclick="changeLanguage('tamil')">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</a>
                    <a href="#" class="dropdown-item" onclick="changeLanguage('english')">English</a>
                </div>
            </div>
        </div>
    </header>
    <div class="main-container">
        <!-- Left File Container - Same structure as chatbot -->
        <div class="left-section file-container">
            <div id="filebox">
                <!-- File list will appear here -->
                <div class="file-message">üìÅ Files will appear here</div>
            </div>
            <div class="button-container">
                <button id="refreshFilesBtn" class="clear-chat-button">üîÑ Refresh</button>
            </div>
            <div class="footer-like">
            
            </div>
        </div>
        
        <div class="chat-container">
            <!-- Center content will go here -->
        </div>
        <div class="left-section">
            <div id="chatbox">
                <!-- Placeholder for chat messages -->
                <div class="message"></div>
            </div>
            <div class="button-container">
                <button id="clearChatBtn" class="clear-chat-button">Clear Chat</button>
            </div>
            <div class="input-container">
                <div class="input-wrapper">
                    <input type="text" id="userInput" class="chat-input" placeholder="‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡ÆØ‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç..." autofocus>
                    <button id="micBtn" class="mic-button" title="‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡Æ§‡Æü‡Øç‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç">
                        <svg class="mic-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle class="mic-border" cx="12" cy="12" r="11" stroke="#333" stroke-width="2" fill="white"/>
                            <circle class="mic-record-circle" cx="12" cy="12" r="9" fill="#2196F3"/>
                            <circle class="mic-center" cx="12" cy="12" r="3" fill="#333"/>
                        </svg>
                    </button>
                </div>
                <button id="sendBtn" class="send-button">‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æµ‡ØÅ‡ÆÆ‡Øç</button>
                <button id="stopBtn" class="stop-button" style="display: none;">
                    <svg class="stop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12" />
                    </svg>
                </button>
            </div>
            <div class="footer-like">
            
            </div>
        </div>
    </div>  
    <div id="loading" class="loading-spinner" style="display: none;"></div>
    <script src="app.js"></script>
    <script src="enhanced-viewer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownButtons = document.querySelectorAll('.menu-button');
            
            dropdownButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Close all other dropdowns
                    dropdownButtons.forEach(otherButton => {
                        if (otherButton !== button) {
                            otherButton.nextElementSibling.classList.remove('show');
                        }
                    });
                    
                    // Toggle current dropdown
                    const dropdownContent = this.nextElementSibling;
                    dropdownContent.classList.toggle('show');
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    const dropdowns = document.querySelectorAll('.dropdown-content');
                    dropdowns.forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                }
            });
            
            // Prevent dropdown from closing when clicking inside it
            const dropdownContents = document.querySelectorAll('.dropdown-content');
            dropdownContents.forEach(content => {
                content.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });

            // Add click handlers for dropdown items
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get the onclick handler and execute it
                    const onclickHandler = this.getAttribute('onclick');
                    if (onclickHandler) {
                        try {
                            // Execute the onclick handler
                            eval(onclickHandler);
                        } catch (error) {
                            console.error('Error executing onclick handler:', error);
                        }
                    }
                    
                    // Close the dropdown after clicking an item
                    this.closest('.dropdown-content').classList.remove('show');
                });
            });
            
            // Add event listener for refresh button to test functionality
            const refreshBtn = document.getElementById('refreshFilesBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    refreshFiles(); // Just call the refresh function instead of adding test files
                });
            }
        });

        // File container functions - integrated with existing tools
        function refreshFiles() {
            console.log('Refreshing file list...');
            // Clear and refresh the file display
            const filebox = document.getElementById('filebox');
            if (filebox.children.length === 0) {
                filebox.innerHTML = '<div class="file-message">üìÅ Files will appear here</div>';
            }
        }
        
        // Simple file structure
        let fileList = [];
        
        // File upload integration with existing tools
        function addFileToContainer(fileName, fileExt, fileContent = null) {
            const filebox = document.getElementById('filebox');
            
            // Clear the "Files will appear here" message if it exists
            const placeholder = filebox.querySelector('.file-message');
            if (placeholder && placeholder.textContent.includes('Files will appear here')) {
                placeholder.remove();
            }
            
            // Add file to list
            fileList.push({
                name: fileName,
                ext: fileExt,
                content: fileContent,
                type: 'file'
            });
            
            // Create file item with ">" icon
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="expand-icon">&gt;</span>
                <span class="file-icon">${getFileIcon(fileExt)}</span>
                <span class="file-name">${fileName}</span>
            `;
            
            // Add click handler
            fileItem.addEventListener('click', function() {
                handleFileClick(fileName, fileContent);
            });
            
            filebox.appendChild(fileItem);
        }
        
        function addFolderToContainer(folderName) {
            const filebox = document.getElementById('filebox');
            
            // Clear the "Files will appear here" message if it exists
            const placeholder = filebox.querySelector('.file-message');
            if (placeholder && placeholder.textContent.includes('Files will appear here')) {
                placeholder.remove();
            }
            
            // Create folder item with ">" icon
            const folderItem = document.createElement('div');
            folderItem.className = 'file-item folder-item';
            folderItem.innerHTML = `
                <span class="expand-icon">&gt;</span>
                <span class="file-icon">üìÅ</span>
                <span class="file-name">${folderName}</span>
            `;
            
            // Add expand functionality
            folderItem.addEventListener('click', function() {
                this.classList.toggle('expanded');
                const icon = this.querySelector('.expand-icon');
                if (this.classList.contains('expanded')) {
                    icon.style.transform = 'rotate(90deg)';
                } else {
                    icon.style.transform = 'rotate(0deg)';
                }
            });
            
            filebox.appendChild(folderItem);
        }
        
        function getFileExtension(fileName) {
            return fileName.split('.').pop().toLowerCase();
        }
        
        function getFileIcon(ext) {
            const icons = {
                'js': 'üü®',
                'html': 'üåê',
                'css': 'üé®',
                'py': 'üêç',
                'json': 'üìã',
                'md': 'üìù',
                'txt': 'üìÑ',
                'pdf': 'üìï',
                'doc': 'üìò',
                'docx': 'üìò',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'gif': 'üñºÔ∏è',
                'zip': 'üì¶',
                'csv': 'üìä',
                'xml': 'üì∞'
            };
            return icons[ext] || 'üìÑ';
        }
        
        function getFileSize(content) {
            if (!content) return '';
            const size = new Blob([content]).size;
            if (size < 1024) return `${size}B`;
            if (size < 1024 * 1024) return `${(size / 1024).toFixed(1)}KB`;
            return `${(size / (1024 * 1024)).toFixed(1)}MB`;
        }
        
        function handleFileClick(fileName, content) {
            console.log('File clicked:', fileName);
            // Check if it's a document file that needs backend processing
            const fileExt = getFileExtension(fileName);
            if (['doc', 'docx', 'pdf'].includes(fileExt)) {
                // Use backend for document viewing
                displayDocumentFromBackend(fileName);
            } else {
                // Display local content for other files
                displayFileInCenter(fileName, content);
            }
        }
        
        async function displayDocumentFromBackend(fileName) {
            const chatContainer = document.querySelector('.chat-container');
            if (!chatContainer) return;
            
            // Show loading state
            chatContainer.innerHTML = `
                <div class="file-viewer">
                    <div class="file-viewer-header">
                        <h3>üìÑ ${fileName}</h3>
                        <button onclick="closeFileViewer()" class="close-btn">‚úï</button>
                    </div>
                    <div class="file-viewer-content" style="text-align: center; padding: 50px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #666;"></i>
                        <p>Loading document...</p>
                    </div>
                </div>
            `;
            
            try {
                // Fetch document HTML from backend
                const response = await fetch(`http://localhost:8090/view_document/${encodeURIComponent(fileName)}`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    
                    if (contentType && contentType.includes('application/json')) {
                        // Handle JSON response from backend
                        const data = await response.json();
                        
                        if (data.success && data.pages && data.pages.length > 0) {
                            // Use the exact structure from original viewer
                            chatContainer.innerHTML = `
                                <div class="word-viewer">
                                    <div class="word-toolbar">
                                        <div class="word-toolbar-group">
                                            <span>${fileName}</span>
                                            <div class="close-document" onclick="closeFileViewer()" title="Close">
                                                <i class="fas fa-times"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="word-viewer-container">
                                        <div class="word-content">
                                            ${data.pages.map((page, index) => `
                                                <div class="word-page">
                                                    ${page}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            throw new Error(data.error || 'Failed to load document');
                        }
                    } else {
                        // Handle HTML response
                        const html = await response.text();
                        chatContainer.innerHTML = `
                            <div class="file-viewer">
                                <div class="file-viewer-header">
                                    <h3>üìÑ ${fileName}</h3>
                                    <button onclick="closeFileViewer()" class="close-btn">‚úï</button>
                                </div>
                                <div class="file-viewer-content">
                                    ${html}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Failed to load document');
                }
            } catch (error) {
                console.error('Error loading document:', error);
                chatContainer.innerHTML = `
                    <div class="file-viewer">
                        <div class="file-viewer-header">
                            <h3>üìÑ ${fileName}</h3>
                            <button onclick="closeFileViewer()" class="close-btn">‚úï</button>
                        </div>
                        <div class="file-viewer-content" style="text-align: center; padding: 50px; color: #e74c3c;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px;"></i>
                            <p>Error loading document. Please ensure the backend is running.</p>
                        </div>
                    </div>
                `;
            }
        }
        
        function displayFileInCenter(fileName, content) {
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                chatContainer.innerHTML = `
                    <div class="file-viewer">
                        <div class="file-viewer-header">
                            <h3>üìÑ ${fileName}</h3>
                            <button onclick="closeFileViewer()" class="close-btn">‚úï</button>
                        </div>
                        <div class="file-viewer-content">
                            <pre>${content || 'File content will be loaded here...'}</pre>
                        </div>
                    </div>
                `;
            }
        }
        
        function closeFileViewer() {
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                chatContainer.innerHTML = '<!-- Center content will go here -->';
            }
        }
        
        // Enhanced file upload functions that integrate with file container
        function handleUploadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.pdf,.txt,.doc,.docx';
            input.onchange = async function(e) {
                const files = Array.from(e.target.files);
                const t = translations[localStorage.getItem('language') || 'tamil'];
                
                for (const file of files) {
                    // Create FormData for RAG upload
                    const formData = new FormData();
                    formData.append('document', file);
                    
                    try {
                        // Upload to RAG endpoint
                        const response = await fetch('http://localhost:8090/rag/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            // Use the filename from response if available, otherwise use original
                            const actualFileName = result.filename || file.name;
                            const fileExt = getFileExtension(actualFileName);
                            
                            // Add to file container with actual filename
                            addFileToContainer(actualFileName, fileExt, null);
                            
                            // Add to chat with success message
                            const message = document.createElement('div');
                            message.className = 'message bot-message';
                            message.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.uploadedFile}${file.name}`;
                            const chatbox = document.getElementById('chatbox');
                            if (chatbox) {
                                chatbox.appendChild(message);
                                chatbox.scrollTop = chatbox.scrollHeight;
                            }
                        } else {
                            console.error('Upload failed:', await response.text());
                            alert('Failed to upload: ' + file.name);
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        // Fallback to local file handling
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const fileContent = event.target.result;
                            const fileExt = getFileExtension(file.name);
                            addFileToContainer(file.name, fileExt, fileContent);
                        };
                        reader.readAsText(file);
                    }
                }
            };
            input.click();
        }
        
        function handleOpenFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.pdf,.doc,.docx,.js,.html,.css,.py,.json,.md,.csv,.xml';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const t = translations[localStorage.getItem('language') || 'tamil'];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const fileContent = event.target.result;
                        const fileExt = getFileExtension(file.name);
                        
                        // Add to file container
                        addFileToContainer(file.name, fileExt, fileContent);
                        
                        // Add to chat (existing functionality)
                        const message = document.createElement('div');
                        message.className = 'message bot-message';
                        message.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.openedFile}${file.name}`;
                        const chatbox = document.getElementById('chatbox');
                        if (chatbox) {
                            chatbox.appendChild(message);
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }
                    };
                    
                    // Read file based on type
                    if (file.type.startsWith('text/') || file.name.endsWith('.js') || file.name.endsWith('.html') || file.name.endsWith('.css') || file.name.endsWith('.json') || file.name.endsWith('.md')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsDataURL(file);
                    }
                }
            };
            input.click();
        }
        
        function handleOpenFolder() {
            const input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                const t = translations[localStorage.getItem('language') || 'tamil'];
                
                // Add to chat (existing functionality)
                const message = document.createElement('div');
                message.className = 'message bot-message';
                message.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.openedFolder}${files.length}`;
                const chatbox = document.getElementById('chatbox');
                if (chatbox) {
                    chatbox.appendChild(message);
                    chatbox.scrollTop = chatbox.scrollHeight;
                }
                
                // Add files to file container
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const fileContent = event.target.result;
                        const fileExt = getFileExtension(file.name);
                        const relativePath = file.webkitRelativePath || file.name;
                        
                        // Add to file container
                        addFileToContainer(relativePath, fileExt, fileContent);
                    };
                    
                    // Read file based on type
                    if (file.type.startsWith('text/') || file.name.endsWith('.js') || file.name.endsWith('.html') || file.name.endsWith('.css') || file.name.endsWith('.json') || file.name.endsWith('.md')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsDataURL(file);
                    }
                });
            };
            input.click();
        }
        
        // Create file and folder functionality
        function createNewFile() {
            const fileName = prompt('Enter file name (with extension):');
            if (fileName && fileName.trim()) {
                const fileExt = getFileExtension(fileName);
                const defaultContent = getDefaultFileContent(fileExt);
                addFileToContainer(fileName, fileExt, defaultContent);
                
                // Also add to chat
                const t = translations[localStorage.getItem('language') || 'tamil'];
                const message = document.createElement('div');
                message.className = 'message bot-message';
                message.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">Created file: ${fileName}`;
                const chatbox = document.getElementById('chatbox');
                if (chatbox) {
                    chatbox.appendChild(message);
                    chatbox.scrollTop = chatbox.scrollHeight;
                }
            }
            hideCreateOptions();
        }
        
        function createNewFolder() {
            const folderName = prompt('Enter folder name:');
            if (folderName && folderName.trim()) {
                // Add folder to structure
                if (!fileStructure[folderName]) {
                    fileStructure[folderName] = {
                        type: 'folder',
                        children: {},
                        expanded: false
                    };
                    rebuildFileTree();
                    
                    // Also add to chat
                    const message = document.createElement('div');
                    message.className = 'message bot-message';
                    message.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">Created folder: ${folderName}`;
                    const chatbox = document.getElementById('chatbox');
                    if (chatbox) {
                        chatbox.appendChild(message);
                        chatbox.scrollTop = chatbox.scrollHeight;
                    }
                }
            }
            hideCreateOptions();
        }
        
        function getDefaultFileContent(ext) {
            const templates = {
                'js': '// JavaScript file\nconsole.log("Hello World");',
                'html': '<!DOCTYPE html>\n<html>\n<head>\n    <title>New Page</title>\n</head>\n<body>\n    <h1>Hello World</h1>\n</body>\n</html>',
                'css': '/* CSS file */\nbody {\n    font-family: Arial, sans-serif;\n    margin: 0;\n    padding: 20px;\n}',
                'py': '# Python file\nprint("Hello World")',
                'json': '{\n    "name": "example",\n    "value": "Hello World"\n}',
                'md': '# New Document\n\nThis is a new markdown document.',
                'txt': 'This is a new text file.'
            };
            return templates[ext] || 'New file content';
        }
        
        function showCreateOptions() {
            const options = document.querySelector('.create-options');
            options.classList.add('show');
        }
        
        function hideCreateOptions() {
            const options = document.querySelector('.create-options');
            options.classList.remove('show');
        }
        
        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const refreshBtn = document.getElementById('refreshFilesBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshFiles);
            }
            
            const createBtn = document.getElementById('createBtn');
            if (createBtn) {
                createBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const options = document.querySelector('.create-options');
                    options.classList.toggle('show');
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.create-dropdown')) {
                    hideCreateOptions();
                }
            });
        });

        function handleSaveAs() {
            const chatContent = document.getElementById('chatbox').innerText;
            const blob = new Blob([chatContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat_history.txt';
            a.click();
            window.URL.revokeObjectURL(url);
            
            const t = translations[localStorage.getItem('language') || 'tamil'];
            const message = document.createElement('div');
            message.className = 'message bot-message';
            message.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.chatSaved}`;
            document.getElementById('chatbox').appendChild(message);
        }

        // Agent handling functions
        function handleBrowserAgent() {
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                chatContainer.innerHTML = `
                    <div class="browser-agent-container">
                        <div class="browser-agent-header">
                            <h3>üåê Browser Agent</h3>
                            <button onclick="closeBrowserAgent()" class="close-btn">‚úï</button>
                        </div>
                        <div class="browser-agent-content">
                            <iframe src="http://127.0.0.1:7788" 
                                    style="width: 100%; height: 100%; border: none; border-radius: 8px;"
                                    id="browserAgentFrame"
                                    frameborder="0">
                            </iframe>
                        </div>
                    </div>
                `;
            }
        }
        
        function closeBrowserAgent() {
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                chatContainer.innerHTML = '<!-- Center content will go here -->';
            }
        }

        // Placeholder for automation functions
        async function startAutomation(action) {
            const statusLog = document.getElementById('statusLog');
            const results = document.getElementById('automationResults');
            
            try {
                statusLog.innerHTML += `<div>Starting ${action}...</div>`;
                
                // Here we would call your actual automation functions
                // For example:
                // if (action === 'navigate') {
                //     await yourAutomationModule.navigateToUrl(url);
                // }
                
                statusLog.innerHTML += `<div>${action} completed successfully</div>`;
            } catch (error) {
                statusLog.innerHTML += `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function handleDocumentAgent() {
            const t = translations[localStorage.getItem('language') || 'tamil'];
            const message = document.createElement('div');
            message.className = 'message bot-message agent-message';
            message.innerHTML = `
                <img src="/static2.0/Durga.png" alt="AI">
                ${t.documentAgentMsg}
            `;
            document.getElementById('chatbox').appendChild(message);
            document.getElementById('userInput').placeholder = t.documentAgent;
        }

        function handleTwitterAgent() {
            const t = translations[localStorage.getItem('language') || 'tamil'];
            const message = document.createElement('div');
            message.className = 'message bot-message agent-message';
            message.innerHTML = `
                <img src="/static2.0/Durga.png" alt="AI">
                ${t.twitterAgentMsg}
            `;
            document.getElementById('chatbox').appendChild(message);
            document.getElementById('userInput').placeholder = t.twitterAgent;
        }

        // First, add a function to create and show the default welcome message
        function showDefaultMode() {
            const t = translations[localStorage.getItem('language') || 'tamil'];
            const chatbox = document.getElementById('chatbox');
            
            // Only show welcome message if chatbox is empty or only contains empty message div
            if (!chatbox.children.length || (chatbox.children.length === 1 && !chatbox.children[0].textContent.trim())) {
                const message = document.createElement('div');
                message.className = 'message bot-message welcome-message';
                message.innerHTML = `
                    <img src="/static2.0/Durga.png" alt="AI">
                    ${t.welcomeMessage}
                `;
                chatbox.innerHTML = ''; // Clear any empty message divs
                chatbox.appendChild(message);
            }
            
            // Reset the input placeholder to default
            document.getElementById('userInput').placeholder = t.inputPlaceholder;
        }

        // Add clear chat functionality
        function handleClearChat() {
            const chatbox = document.getElementById('chatbox');
            chatbox.innerHTML = ''; // Clear all messages
            showDefaultMode(); // Show welcome message after clearing
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Show default welcome message only on initial load
            showDefaultMode();
            
            // Add click handler for clear chat button
            document.getElementById('clearChatBtn').addEventListener('click', handleClearChat);
            
            // Load saved language preference
            const savedLang = localStorage.getItem('language') || 'tamil';
            changeLanguage(savedLang);
        });

        // Language translations
        const translations = {
            tamil: {
                title: '‡Æ§‡ØÅ‡Æ∞‡Øç‡Æï‡Ææ AI',
                files: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç',
                agents: '‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç',
                language: '‡ÆÆ‡Øä‡Æ¥‡Æø',
                uploadFile: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç',
                openFile: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Øà‡Æ§‡Øç ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
                openFolder: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æ±‡Øà‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
                saveAs: '‡Æá‡Æµ‡Øç‡Æµ‡Ææ‡Æ±‡ØÅ ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
                browserAgent: '‡Æâ‡Æ≤‡Ææ‡Æµ‡Æø ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø‡Æü‡ÆÆ‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç...',
                documentAgent: '‡ÆÜ‡Æµ‡Æ£ ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø‡Æü‡ÆÆ‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç...',
                twitterAgent: '‡Æü‡Øç‡Æµ‡Æø‡Æü‡Øç‡Æü‡Æ∞‡Øç ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø‡Æü‡ÆÆ‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç...',
                clearChat: '‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà‡ÆØ‡Øà ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
                inputPlaceholder: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡ÆØ‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç...',
                send: '‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æµ‡ØÅ‡ÆÆ‡Øç',
                micTitle: '‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡Æ§‡Æü‡Øç‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç',
                browserAgentMsg: '‡Æâ‡Æ≤‡Ææ‡Æµ‡Æø ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡Æ®‡Ææ‡Æ©‡Øç ‡Æé‡Æµ‡Øç‡Æµ‡Ææ‡Æ±‡ØÅ ‡Æâ‡Æ§‡Æµ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç?',
                documentAgentMsg: '‡ÆÜ‡Æµ‡Æ£ ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡ÆÜ‡Æµ‡Æ£‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æ§‡Æµ‡ØÅ‡Æµ‡Øá‡Æ©‡Øç.',
                twitterAgentMsg: '‡Æü‡Øç‡Æµ‡Æø‡Æü‡Øç‡Æü‡Æ∞‡Øç ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡Æü‡Øç‡Æµ‡Æø‡Æü‡Øç‡Æü‡Æ∞‡Øç ‡Æ§‡Æ∞‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æ§‡Æµ‡ØÅ‡Æµ‡Øá‡Æ©‡Øç.',
                uploadedFile: '‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æø‡ÆØ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ: ',
                openedFile: '‡Æ§‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ: ',
                openedFolder: '‡Æ§‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æ±‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç: ',
                welcomeMessage: '‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æ®‡Ææ‡Æ©‡Øç ‡Æ§‡ØÅ‡Æ∞‡Øç‡Æï‡Ææ AI, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æé‡Æµ‡Øç‡Æµ‡Ææ‡Æ±‡ØÅ ‡Æâ‡Æ§‡Æµ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç?',
                uploadSuccess: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ',
                fileOpened: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ',
                folderOpened: '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æ±‡Øà ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ',
                chatSaved: '‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ',
                browserAgentName: '‡Æâ‡Æ≤‡Ææ‡Æµ‡Æø ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç',
                documentAgentName: '‡ÆÜ‡Æµ‡Æ£ ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç',
                twitterAgentName: '‡Æü‡Øç‡Æµ‡Æø‡Æü‡Øç‡Æü‡Æ∞‡Øç ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç'
            },
            english: {
                title: 'Durga AI',
                files: 'Files',
                agents: 'Agents',
                language: 'Language',
                uploadFile: 'Upload File',
                openFile: 'Open File',
                openFolder: 'Open Folder',
                saveAs: 'Save As',
                browserAgent: 'Ask the Browser Agent...',
                documentAgent: 'Ask the Document Agent...',
                twitterAgent: 'Ask the Twitter Agent...',
                clearChat: 'Clear Chat',
                inputPlaceholder: 'Type your question...',
                send: 'Send',
                micTitle: 'Click to record',
                browserAgentMsg: 'Browser Agent activated. How can I help you browse the web?',
                documentAgentMsg: 'Document Agent activated. I can help you analyze and work with documents.',
                twitterAgentMsg: 'Twitter Agent activated. I can help you analyze Twitter data and trends.',
                uploadedFile: 'Uploaded file: ',
                openedFile: 'Opened file: ',
                openedFolder: 'Files in opened folder: ',
                welcomeMessage: 'Hello! I am Durga AI, how can I help you?',
                uploadSuccess: 'File uploaded successfully',
                fileOpened: 'File opened successfully',
                folderOpened: 'Folder opened successfully',
                chatSaved: 'Chat history saved',
                browserAgentName: 'Browser Agent',
                documentAgentName: 'Document Agent',
                twitterAgentName: 'Twitter Agent'
            }
        };

        function changeLanguage(lang) {
            // Store language preference
            localStorage.setItem('language', lang);
            
            // Clear and reinitialize chat with new language
            if (typeof clearChat === 'function') {
                clearChat();
            }
            
            // Update UI elements
            const t = translations[lang];
            
            // Update title
            document.title = t.title;
            document.querySelector('.branding h1').textContent = t.title;
            
            // Update menu buttons - Fix the button text comparison
            const menuButtons = document.querySelectorAll('.menu-button');
            menuButtons.forEach(button => {
                // Check the button's position to determine which translation to use
                if (button.parentElement === document.querySelector('.dropdown:nth-child(1)')) {
                    button.textContent = t.files;
                } else if (button.parentElement === document.querySelector('.dropdown:nth-child(2)')) {
                    button.textContent = t.agents;
                } else if (button.parentElement === document.querySelector('.dropdown:nth-child(3)')) {
                    button.textContent = t.language;
                }
            });
            
            // Update dropdown items with agent names
            document.querySelectorAll('.dropdown').forEach((dropdown, index) => {
                const items = dropdown.querySelectorAll('.dropdown-item');
                if (index === 0) { // Files dropdown
                    items[0].textContent = t.uploadFile;
                    items[1].textContent = t.openFile;
                    items[2].textContent = t.openFolder;
                    items[3].textContent = t.saveAs;
                } else if (index === 1) { // Agents dropdown
                    items[0].textContent = t.browserAgentName;
                    items[1].textContent = t.documentAgentName;
                    items[2].textContent = t.twitterAgentName;
                }
                // Language dropdown items remain unchanged
            });
            
            // Update other UI elements
            document.getElementById('clearChatBtn').textContent = t.clearChat;
            document.getElementById('userInput').placeholder = t.inputPlaceholder;
            document.getElementById('sendBtn').textContent = t.send;
            document.getElementById('micBtn').title = t.micTitle;
            
            // Update agent messages
            window.browserAgentMsg = t.browserAgentMsg;
            window.documentAgentMsg = t.documentAgentMsg;
            window.twitterAgentMsg = t.twitterAgentMsg;

            // Update existing chat messages
            const messages = document.querySelectorAll('.bot-message');
            messages.forEach(message => {
                const messageText = message.textContent.trim();
                
                // Create a new message element to preserve the image
                const updatedMessage = document.createElement('div');
                updatedMessage.className = 'message bot-message';
                
                // Check message content and update accordingly
                if (messageText.includes('Browser Agent') || messageText.includes('‡Æâ‡Æ≤‡Ææ‡Æµ‡Æø ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç')) {
                    updatedMessage.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.browserAgentMsg}`;
                    message.innerHTML = updatedMessage.innerHTML;
                    document.getElementById('userInput').placeholder = t.browserAgent;
                }
                else if (messageText.includes('Document Agent') || messageText.includes('‡ÆÜ‡Æµ‡Æ£ ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç')) {
                    updatedMessage.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.documentAgentMsg}`;
                    message.innerHTML = updatedMessage.innerHTML;
                    document.getElementById('userInput').placeholder = t.documentAgent;
                }
                else if (messageText.includes('Twitter Agent') || messageText.includes('‡Æü‡Øç‡Æµ‡Æø‡Æü‡Øç‡Æü‡Æ∞‡Øç ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç')) {
                    updatedMessage.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.twitterAgentMsg}`;
                    message.innerHTML = updatedMessage.innerHTML;
                    document.getElementById('userInput').placeholder = t.twitterAgent;
                }
                else if (messageText.includes('Uploaded file:') || messageText.includes('‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æø‡ÆØ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ:')) {
                    const fileName = messageText.split(':')[1].trim();
                    updatedMessage.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.uploadedFile}${fileName}`;
                    message.innerHTML = updatedMessage.innerHTML;
                }
                else if (messageText.includes('Opened file:') || messageText.includes('‡Æ§‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ:')) {
                    const fileName = messageText.split(':')[1].trim();
                    updatedMessage.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.openedFile}${fileName}`;
                    message.innerHTML = updatedMessage.innerHTML;
                }
                else if (messageText.includes('Opened folder with') || messageText.includes('‡Æ§‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æ±‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç:')) {
                    const fileCount = messageText.match(/\d+/)[0];
                    updatedMessage.innerHTML = `<img src="/static2.0/Durga.png" alt="AI">${t.openedFolder}${fileCount}`;
                    message.innerHTML = updatedMessage.innerHTML;
                }
            });
        }
    </script>
</body>
</html>